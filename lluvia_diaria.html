<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Acumulado Diario Lluvia</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <nav>
    <a href="index.html">üè† Inicio</a>
    <a href="lluvia.html">üìä Lluvia</a>
    <a href="dht21.html">üå°Ô∏è DHT21</a>
    <a href="lluvia_diaria.html">üìÖ Lluvia diaria</a>
    <a href="graficas.html">üìÖ Graficas</a>
  </nav>

  <h2>Acumulado Diario de Lluvia</h2>

  <!-- Filtro por fecha -->
  <label for="filtroFecha">Filtrar por fecha: </label>
  <input type="date" id="filtroFecha">
  <button id="btnReset">Mostrar todos</button>

  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Acumulado (mm)</th>
      </tr>
    </thead>
    <tbody id="tablaAcumulado"></tbody>
  </table>

  <script>
    const tabla = document.getElementById("tablaAcumulado");
    const filtroFecha = document.getElementById("filtroFecha");
    const btnReset = document.getElementById("btnReset");

    // Funci√≥n para mostrar acumulados
    function mostrarAcumulados(fechaFiltro = null) {
      const historial = JSON.parse(localStorage.getItem("lluviaHistorial")) || [];
      const acumulados = {};

      historial.forEach(fila => {
        if (!acumulados[fila.fecha]) {
          acumulados[fila.fecha] = 0;
        }
        acumulados[fila.fecha] += parseFloat(fila.valor) || 0;
      });

      tabla.innerHTML = "";

      let fechas = Object.keys(acumulados).sort().reverse();

      if (fechaFiltro) {
        fechas = fechas.filter(f => f === fechaFiltro);
      }

      fechas.forEach(fecha => {
        tabla.insertAdjacentHTML("beforeend", `<tr>
          <td>${fecha}</td>
          <td>${acumulados[fecha].toFixed(2)}</td>
        </tr>`);
      });
    }

    // Eventos de filtro
    filtroFecha.addEventListener("change", () => {
      mostrarAcumulados(filtroFecha.value);
    });

    btnReset.addEventListener("click", () => {
      filtroFecha.value = "";
      mostrarAcumulados();
    });

    // Render inicial
    mostrarAcumulados();

    // Conexi√≥n MQTT para actualizar en tiempo real
    const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");
    const topic = "sensor/datos";

    client.on("connect", () => {
      client.subscribe(topic);
    });

    client.on("message", (t, message) => {
      try {
        const datos = JSON.parse(message.toString());
        if (datos.tipo !== "lluvia") return;

        const ahora = new Date();
        const fecha = ahora.toISOString().split("T")[0];
        const hora = ahora.toTimeString().split(" ")[0];

        let historial = JSON.parse(localStorage.getItem("lluviaHistorial")) || [];
        historial.push({ fecha, hora, valor: datos.valor ?? 0 });
        localStorage.setItem("lluviaHistorial", JSON.stringify(historial));

        mostrarAcumulados(filtroFecha.value || null);
      } catch (e) {}
    });
  </script>
</body>
</html>
