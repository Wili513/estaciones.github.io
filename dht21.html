<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Datos DHT21</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <nav>
    <a href="index.html">🏠 Inicio</a>
    <a href="lluvia.html">📊 Lluvia</a>
    <a href="dht21.html">🌡️ DHT21</a>
    <a href="lluvia_diaria.html">📅 Lluvia diaria</a>
    <a href="graficas.html">📅 Graficas</a>
  </nav>

  <h2>Datos DHT21 (Temperatura y Humedad)</h2>

  <!-- Filtro -->
  <label for="filtro">Mostrar últimos: </label>
  <select id="filtro">
    <option value="5">5</option>
    <option value="10">10</option>
    <option value="20">20</option>
    <option value="todos">Todos</option>
  </select>

  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Temperatura (°C)</th>
        <th>Humedad (%)</th>
      </tr>
    </thead>
    <tbody id="tablaDHT"></tbody>
  </table>

  <script>
    const tabla = document.getElementById("tablaDHT");
    const filtro = document.getElementById("filtro");
    let historial = JSON.parse(localStorage.getItem("dhtHistorial")) || [];

    // Función para renderizar tabla según filtro
    function renderTabla() {
      tabla.innerHTML = "";
      let datosMostrados;

      if (filtro.value === "todos") {
        datosMostrados = historial.slice().reverse();
      } else {
        const cantidad = parseInt(filtro.value);
        datosMostrados = historial.slice(-cantidad).reverse();
      }

      datosMostrados.forEach(fila => {
        tabla.insertAdjacentHTML("beforeend", `<tr>
          <td>${fila.fecha}</td>
          <td>${fila.hora}</td>
          <td>${fila.temp}</td>
          <td>${fila.hum}</td>
        </tr>`);
      });
    }

    // Evento cuando cambia el filtro
    filtro.addEventListener("change", renderTabla);

    // Render inicial
    renderTabla();

    // MQTT
    const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");
    const topic = "sensor/datos";

    client.on("connect", () => {
      client.subscribe(topic);
    });

    client.on("message", (t, message) => {
      try {
        const datos = JSON.parse(message.toString());
        if (datos.tipo !== "dht21") return;

        const ahora = new Date();
        const fecha = ahora.toISOString().split("T")[0];
        const hora = ahora.toTimeString().split(" ")[0];

        const nuevaFila = { fecha, hora, temp: datos.temperatura ?? "", hum: datos.humedad ?? "" };
        historial.push(nuevaFila);
        localStorage.setItem("dhtHistorial", JSON.stringify(historial));

        renderTabla(); // refrescar según el filtro
      } catch (e) {}
    });
  </script>
</body>
</html>
