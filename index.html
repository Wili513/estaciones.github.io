<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Prueba Google Sheets CSV</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h2 { color: #007bff; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #007bff; color: white; }
  </style>
</head>
<body>
  <h2>Datos desde Google Sheets</h2>
  <table>
    <thead>
      <tr>
        <th>Hora</th>
        <th>Temperatura (°C)</th>
        <th>Humedad (%)</th>
        <th>Lluvia (mm)</th>
      </tr>
    </thead>
    <tbody id="tablaDatos"></tbody>
  </table>

  <script>
    // ✅ Usa el endpoint GViz publicado (no CSV) y se evita CORS
    const GVIZ_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSxObb2nasmk3BsnNDjWiJ8R80J-6Z-pQFcHU5DTYf3ybR4VLBBGxAV6e5JaEuEYY6rPVoRJxeZ4a9_/gviz/tq?tqx=out:json&gid=1773567797";
    //const GVIZ_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTm2ChkKcZ75F8HQSGIDIx18UHtHYzDH-p9wcxsw2IMQyiP9NFQmqLvY7fwh4us6bpHsn3YDiLUIhfp/gviz/tq?tqx=out:json&gid=1825751976";

    function cargarDatosConGViz() {
      // Prepara el manejador global que Google llamará:
      window.google = window.google || {};
      window.google.visualization = window.google.visualization || {};
      window.google.visualization.Query = window.google.visualization.Query || {};

      window.google.visualization.Query.setResponse = function(resp) {
        const tbody = document.getElementById("tablaDatos");
        tbody.innerHTML = "";

        if (!resp || resp.status !== "ok" || !resp.table || !resp.table.rows) {
          tbody.innerHTML = `<tr><td colspan="4" style="color:red;">No se pudieron leer los datos</td></tr>`;
          return;
        }

        // Recorre filas y coloca las 4 primeras columnas (Hora, Temp, Humedad, Lluvia)
        resp.table.rows.forEach(r => {
          const c = r.c || [];
          // Usa valor formateado (f) si existe, si no el valor bruto (v)
          const val = i => (c[i] && (c[i].f ?? c[i].v)) ?? "";

          const tr = document.createElement("tr");
          [val(0), val(1), val(2), val(3)].forEach(v => {
            const td = document.createElement("td");
            td.textContent = v;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      };

      // Inyecta el script (evita CORS) con cache-busting
      const s = document.createElement("script");
      s.src = GVIZ_URL + "&_=" + Date.now();
      s.onerror = () => {
        document.getElementById("tablaDatos").innerHTML =
          `<tr><td colspan="4" style="color:red;">Error cargando la hoja</td></tr>`;
      };
      document.head.appendChild(s);
    }

    document.addEventListener("DOMContentLoaded", cargarDatosConGViz);
  </script>
</body>
</html>
